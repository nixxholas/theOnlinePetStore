<div class="container">
    <div class="col-md-offset-1 col-md-10">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <div class="panel-title">Update Brand Record</div>
            </div>
            <div class="panel-body">
                <form id="dataForm" role="form" class="form-horizontal">
                    <div class="form-group">
                        <label class="control-label col-md-3" for="brandNameInput">Brand Name</label>
                        <div class="col-md-4">
                            <input type="text" id="brandNameInput" class="form-control input-group-sm"
                                   maxlength="50" placeholder="Brand Name" value="" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3">Photo</label>
                        <div class="col-md-4">
                            <img id="currentPhotoImage" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3 updateBrandCategoryListLabelFix" for="categoriesInput">Categories</label>
                        <div class="form-group col-md-9">
                            <div class="form-group" id="categoriesList"></div>
                        </div><!-- End of div element containing label and input for address -->
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3" for="brandPhotoUploadInput">Photo</label>
                        <div class="col-md-9">
                            <input id="fileInput" name="fileInput" type="file" class="file input-group-lg" multiple="true" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3"></label>
                        <div class="col-md-9">
                            <div class="pull-right">
                                <input type="button" class="btn btn-danger" value="Delete" id="deleteButton" />
                                <input type="button" class="btn btn-primary" value="Save" id="saveButton" />
                                <a class="btn btn-default" asp-action="Index" asp-controler="Employees">Cancel</a>
                            </div>
                        </div>
                    </div>
                </form>
            </div><!-- end of div element which has the class="panel-body" -->
        </div><!-- end of the div element which has the class="panel" -->
    </div><!-- end of the div element which has class="col-md-offset-2 col-md-8" -->
</div><!-- end of div element which has the class="container" -->

<script>
    var brandCategories;

    var msCategoryList = $('#categoriesList').magicSuggest({
        method: 'get',
        data: 'http://localhost:4992/API/Categories',
        dataType: 'json',
        displayField: 'CatName',
        valueField: 'CatId',
        allowFreeEntries: false,
        autoSelect: false
    });

    //------------------------------------ Client-side Load Data logic -----------------------------------
    var g_brandId = getBrandIdFromAddressBar();
    function getBrandIdFromAddressBar() {
        //Get employee id from the url string in the browser's address bar
        var urlArray = window.location.href.split('/');
        var id = urlArray[urlArray.length - 1];
        return id;
    };

    $loadBrandsDataHandler = jQuery.ajax({
            contentType: 'application/json',
            method: 'get',
            url: 'http://localhost:4992/API/BrandCategory',
        })
        $loadBrandsDataHandler.done(function (data, textStatus, jqXHR) {
            brandCategories = data;
        }//end of JavaScript anonymous function

          )//end of the done() method;
        $loadBrandsDataHandler.fail(function (data, textStatus, jqXHR) {
            noty({
                text: 'Ajax fail fired : ' + data.responseJSON.Message, type: 'error',
                layout: 'center',
                template: '<div class="noty_message"><span class="noty_text"></span>'
            });//end of noty()
        })//end of $loadCompanyDataHandler.fail()

    //Note: jQuery.ajax(..) is also often written is $.ajax(..)
    $loadBrandHandler = jQuery.ajax({
        type: 'GET',
        url: '/API/Brands/' + g_brandId,
    })
    $loadBrandHandler.done(function (data, textStatus, jqXHR) {
        //After inspecting the data object with the console.log
        //I have clear picture of the structure and used
        //the following variable to reference(represent) the data variable.
        var brand = data;
        //Copy out the brand information
        var brandId = brand.BrandId;
        var brandName = brand.BrandName;
        var brandPhotoUrl = brand.PhotoUrl;
        var categories = [];

        for (i = 0; i < brandCategories.length; i++) {
            if (brandCategories[i].BrandId == brandId && brandCategories.DeletedAt == null) {
                // Add it into the column categories
                categories.push(brandCategories[i].CatId);
            }
        }

        // The loop causes the last two characters to be ", ". Let's remove it.
        //categories = categories.substring(0, categories.length - 2)

        //Populate the respective input controls with the employee details.
        //For example, find the text input control, fullNameInput and set the
        //text input control's value with the fullName variable's content.
        $('#brandNameInput').val(brandName);
        $('#currentPhotoImage').attr('src', brandPhotoUrl);
        msCategoryList.setValue(categories);
    }//end of JavaScript anonymous function

    )//end of the done() method;

    //------------------------------------ Client-side Load Data logic ---(End)---------------------------

    //------------------------------------ Client-side Upload logic -----------------------------------------
    window.$brandPhotoInputElement = $('#fileInput');
    var footerTemplate = '<div class="file-thumbnail-footer">\n' +
    '    <div class="file-caption-name" style="width:{width}">{caption}</div>\n' +
    '    {actions}\n' +
    '</div>';
    var actionTemplate = '<div class="file-actions">\n' +
     '       <div class="file-footer-buttons">\n {delete} </div>\n' +
     '    <div class="file-upload-indicator" tabindex="-1" title="{indicatorTitle}">{indicator}</div>\n' +
     '    <div class="clearfix"></div>\n' +
     '</div>';
    window.$brandPhotoInputElement.fileinput({
        previewFileType: 'image',
        allowedFileTypes: ['image'],
        uploadUrl: '/API/Brands/UploadBrandPhotoAndUpdateBrandData',
        uploadAsync: false,
        maxFileCount: 1,
        layoutTemplates: { footer: footerTemplate, actions: actionTemplate },
        type: 'post',
        msgInvalidFileType: 'Invalid type for file "{name}". Only "{types}" files are supported.',
        autoReplace: true,/*http://plugins.krajee.com/file-auto-replace-demo*/
        overwriteInitial: false,
        showUploadedThumbs: false,
        showUpload: false,
        showRemove: false,
        browseClass: 'btn btn-primary btn-md pull-right',
        previewFileIcon: '<i class="glyphicon glyphicon-king"></i>',
        allowedFileExtensions: ['jpg', 'jpeg', 'png'],
        uploadExtraData: function () {  // callback example
            var out = {};
            return out;
        }
    });

    window.$brandPhotoInputElement.on('filebatchuploadsuccess',
                  function (event, data, previewId, index) {
                      //It is not necessary that an upload has occurred because the user
                      //may have only made changes to the employee data but did not
                      //select a new file.
                      var form = data.form, files = data.files, extra = data.extra,
                      response = data.response, reader = data.reader;
                      console.log(data.Message);
                      console.log(event);
                      console.dir(data);
                      noty({
                          text: data.jqXHR.responseJSON.Message,
                          type: 'success',
                          layout: 'center',
                          template: '<div class="noty_message"><span class="noty_text"></span>'
                      });
                      var newImageUrl = data.jqXHR.responseJSON.NewImageUrl;
                      $('#currentPhotoImage').attr('src', newImageUrl);
                  });
    //----------------------------------------- Client-side Upload logic ---(End)----------------------


    //----------------------------------------- Client-side Update logic --------------------------------
    $('#saveButton').on('click', function () {
        //Collect data from input elements
        var collectedBrandName = $('#brandNameInput').val();
        var collectedCategories = JSON.stringify(msCategoryList.getValue()); // Category Id Array!!

        var fileName = $brandPhotoInputElement.val();

        var numberOfFiles = 0;
        if (fileName != '') {
            numberOfFiles = 1;
        }

        var webFormData = new WebFormData(collectedBrandName,
                    collectedCategories);

        var webFormDataInString = JSON.stringify(webFormData);

        if (numberOfFiles > 0) {
            $saveBrandHandler = jQuery.ajax({
                method: 'PUT',
                contentType: 'application/json',
                url: '/Api/Brands/SaveBrandUpdateInformationIntoSession/' + g_brandId,
                data: "'" + webFormDataInString + "'"
            });
            $saveBrandHandler.done(function (data, textStatus, jqXHR) {
                if (window.$brandPhotoInputElement.val() != '') {
                    //Using this command will get the FileUpload widget to begin upload
                    window.$brandPhotoInputElement.fileinput('upload');
                } else {
                    noty({
                        text: data.Message,
                        type: 'success',
                        layout: 'center',
                        template: '<div class="noty_message"><span class="noty_text"></span>'
                    });
                }
            });
            $saveBrandHandler.fail(function (data, textStatus, jqXHR) {
                noty({
                    text: data.responseJSON.Message,
                    type: 'error',
                    layout: 'center',
                    template: '<div class="noty_message"><span class="noty_text"></span>'
                });
            });
        }//end of if (numberOfFiles>0) condition block

        if (numberOfFiles == 0) {
            $saveBrandHandler = jQuery.ajax({
                method: 'PUT',
                contentType: 'application/json',
                url: '/Api/Brands/SaveBrandUpdateInformationIntoDatabase/' + g_brandId,
                data: "'" + webFormDataInString + "'"
            });
            $saveBrandHandler.done(function (data, textStatus, jqXHR) {
                noty({
                    text: data.Message,
                    type: 'success',
                    layout: 'center',
                    template: '<div class="noty_message"><span class="noty_text"></span>'
                });
            });
            $saveBrandHandler.fail(function (data, textStatus, jqXHR) {
                noty({
                    text: data.responseJSON.Message,
                    type: 'error',
                    layout: 'center',
                    template: '<div class="noty_message"><span class="noty_text"></span>'
                });
            });

        }//end of if (numberOfFiles==0) condition block


    });
    //Define the object constructor, WebFormData which you can create
    //a suitable object of information which is needed by the Web API Post() method

    function WebFormData(inBrandName, inCategories) {
        this.BrandName = inBrandName;
        this.BrandCategories = inCategories;
    }
    //----------------------------------------- Client-Side Update logic ---(End)-------------------------------------

    //----------------------------------------- Client-side Delete logic -------------------------------------------------
    $('#deleteButton').on('click', function () {
        $deleteBrandHandler = jQuery.ajax({
            type: 'DELETE',
            url: '/API/Brands/' + g_brandId
        })//end of jQuery.ajax() call
        $deleteBrandHandler.done(function (data, textStatus, jqXHR) {
            noty({
                text: data.Message, type: 'success',
                layout: 'center',
                template: '<div class="noty_message" style="height:50px;"><span class="noty_text"></span>',
                buttons: [
                        {
                            addClass: 'btn btn-primary', text: 'Ok', onClick: function ($noty) {
                                $noty.close();
                                $('body').fadeOut(2000, redirectPage);
                            }
                        }
                ]
            });//end of noty()
        });//end of $deleteEmployeeHandler.done()

        $deleteBrandHandler.fail(function (data, textStatus, jqXHR) {
            console.log(data);
            noty({
                text: data.responseJSON.Message, type: 'error',
                layout: 'center',
                template: '<div class="noty_message"><span class="noty_text"></span>'
            });//end of noty()
        });//end of $deleteEmployeeHandler.fail()

    });// end of $('#deleteButton').on('click', function () { ...}
    function redirectPage() {
        location.replace('/Brands/Index');
    }// end of redirectPage() method (function)
    //----------------------------------------- Client-side Delete logic -(End)-------------------------------------------
</script>
